<div class="h-screen w-screen flex items-center justify-center gap-48" style="background-color: #D77757;">
  <div class="eyes-container" id="eyes">
    <div class="eye left-eye" id="left-eye"></div>
    <div class="eye right-eye" id="right-eye"></div>
  </div>

  <!-- 8-bit Settings Icon -->
  <button class="settings-btn" id="settings-btn" title="Settings">
    <svg class="settings-icon" viewBox="0 0 16 16" fill="currentColor">
      <!-- 8-bit gear icon -->
      <rect x="6" y="0" width="4" height="2"/>
      <rect x="6" y="14" width="4" height="2"/>
      <rect x="0" y="6" width="2" height="4"/>
      <rect x="14" y="6" width="2" height="4"/>
      <rect x="2" y="2" width="2" height="2"/>
      <rect x="12" y="2" width="2" height="2"/>
      <rect x="2" y="12" width="2" height="2"/>
      <rect x="12" y="12" width="2" height="2"/>
      <rect x="4" y="4" width="8" height="8"/>
      <rect x="6" y="6" width="4" height="4" fill="#D77757"/>
    </svg>
  </button>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settings-modal">
    <div class="settings-panel">
      <div class="settings-header">
        <h2>‚öôÔ∏è YOUR SESSION</h2>
        <button class="close-btn" id="close-settings">‚úï</button>
      </div>
      
      <div class="settings-content">
        <!-- Connection Status -->
        <div class="connection-status" id="connection-status">
          <span class="status-dot" id="status-dot"></span>
          <span class="status-text" id="status-text">Checking...</span>
        </div>

        <!-- Session Name -->
        <div class="setting-group">
          <label for="session-name">SESSION NAME</label>
          <input type="text" id="session-name" placeholder="My Computer" />
          <span class="setting-hint">A friendly name for this session</span>
        </div>

        <!-- Session Token -->
        <div class="setting-group">
          <label>SESSION TOKEN</label>
          <div class="token-display">
            <code id="session-token">Loading...</code>
            <button class="btn-icon" id="copy-token" title="Copy Token">üìã</button>
          </div>
          <span class="setting-hint">Your unique session identifier (keep this private!)</span>
        </div>

        <div class="settings-status" id="settings-status"></div>

        <!-- Primary Actions -->
        <div class="settings-actions">
          <button class="btn-primary btn-large" id="download-hooks">
            üì• DOWNLOAD HOOKS
          </button>
        </div>

        <!-- Setup Instructions -->
        <div class="setup-instructions">
          <h3>üìù SETUP</h3>
          <ol>
            <li>Download hooks above</li>
            <li>Extract to <code>~/.claude/hooks/</code></li>
            <li>Make executable: <code>chmod +x ~/.claude/hooks/*</code></li>
            <li>Restart Claude Code</li>
          </ol>
        </div>

        <!-- Advanced Settings Toggle -->
        <details class="advanced-settings">
          <summary>‚ö° Advanced Settings</summary>
          
          <div class="setting-group">
            <label for="working-timeout">WORKING TIMEOUT (seconds)</label>
            <input type="number" id="working-timeout" min="1" max="60" value="5" />
            <span class="setting-hint">Return to idle if no events after this duration</span>
          </div>

          <div class="setting-group">
            <label for="inactivity-timeout">SLEEP TIMEOUT (minutes)</label>
            <input type="number" id="inactivity-timeout" min="1" max="30" value="2" />
            <span class="setting-hint">Go to sleep after this duration of inactivity</span>
          </div>

          <div class="settings-actions">
            <button class="btn-secondary" id="save-settings">SAVE SETTINGS</button>
            <button class="btn-danger" id="regenerate-token">üîÑ NEW TOKEN</button>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

  .eyes-container {
    display: flex;
    gap: 12rem;
    image-rendering: pixelated;
  }

  .eye {
    width: 64px;
    height: 192px;
    background-color: #000;
    border-radius: 0;
    box-shadow:
      8px 0 0 #000,
      -8px 0 0 #000;
    transition: all 0.1s steps(2);
    position: relative;
  }

  /* Create pixel art shimmer effect */
  .eye::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: rgba(255, 255, 255, 0.3);
    top: 32px;
    left: 8px;
    opacity: 0;
  }

  .eye.shimmer::after {
    animation: shimmer 0.3s steps(2);
  }


  /* Classic pixel art animations - Enhanced with natural motion */
  .eye.blink { animation: blink 0.15s steps(2); }
  .eye.double-blink { animation: doubleBlink 0.4s steps(2); }
  .eye.sleepy { animation: sleepy 1.2s steps(8); }
  .eye.look-left { animation: lookLeft 0.5s steps(6); }
  .eye.look-right { animation: lookRight 0.5s steps(6); }
  .eye.look-up { animation: lookUp 0.4s steps(5); }
  .eye.squint { animation: squint 0.5s steps(5); }
  .eye.wide { animation: wide 0.4s steps(5); }

  /* Emotion state animations - TRUE 8-bit chunky frames */
  .eye.state-thinking { animation: thinking 1.6s steps(6) infinite; }
  .eye.state-working { animation: working 2s steps(8) infinite; }
  .eye.state-sleeping {
    height: 32px;
    width: 80px;
    animation: sleeping 2.5s steps(8) infinite;
  }
  .eye.state-happy { animation: happy 0.8s steps(6) infinite; }
  .eye.state-error { animation: error 0.3s steps(3) infinite; }

  @keyframes blink {
    0%, 100% { height: 192px; }
    50% { height: 8px; }
  }

  @keyframes doubleBlink {
    0%, 100% { height: 192px; }
    20%, 60% { height: 8px; }
    40%, 80% { height: 192px; }
  }

  /* Sleepy: Heavy eyelids drooping - fighting sleep */
  @keyframes sleepy {
    0% { height: 192px; transform: translateY(0); }
    /* Eyes start drooping */
    20% { height: 128px; transform: translateY(32px); }
    /* Almost closed - fighting it */
    40% { height: 64px; transform: translateY(64px); }
    /* Jolt awake slightly */
    50% { height: 96px; transform: translateY(48px); }
    /* Droop again */
    70% { height: 64px; transform: translateY(64px); }
    /* Force eyes back open */
    85% { height: 160px; transform: translateY(16px); }
    100% { height: 192px; transform: translateY(0); }
  }

  /* Look Left: Natural glance with anticipation */
  @keyframes lookLeft {
    0% { transform: translateX(0) translateY(0); }
    /* Slight anticipation - look right first */
    15% { transform: translateX(8px) translateY(0); }
    /* Snap to look left */
    30% { transform: translateX(-32px) translateY(-8px); }
    /* Hold gaze */
    50% { transform: translateX(-32px) translateY(-8px); }
    /* Return with slight overshoot */
    75% { transform: translateX(8px) translateY(0); }
    /* Settle */
    100% { transform: translateX(0) translateY(0); }
  }

  /* Look Right: Natural glance with anticipation */
  @keyframes lookRight {
    0% { transform: translateX(0) translateY(0); }
    /* Slight anticipation - look left first */
    15% { transform: translateX(-8px) translateY(0); }
    /* Snap to look right */
    30% { transform: translateX(32px) translateY(-8px); }
    /* Hold gaze */
    50% { transform: translateX(32px) translateY(-8px); }
    /* Return with slight overshoot */
    75% { transform: translateX(-8px) translateY(0); }
    /* Settle */
    100% { transform: translateX(0) translateY(0); }
  }

  /* Look Up: Curious upward gaze with slight squint */
  @keyframes lookUp {
    0% { transform: translateY(0); height: 192px; }
    /* Slight squint as looking up */
    25% { transform: translateY(-16px); height: 176px; }
    /* Full upward gaze */
    40%, 60% { transform: translateY(-32px); height: 168px; }
    /* Relax back */
    80% { transform: translateY(-8px); height: 184px; }
    100% { transform: translateY(0); height: 192px; }
  }

  /* Squint: Suspicious narrowing - pure 8-bit */
  @keyframes squint {
    0%, 100% { height: 192px; transform: translateY(0); }
    /* Start narrowing */
    20% { height: 128px; transform: translateY(32px); }
    /* Full suspicious squint */
    35%, 65% { height: 64px; transform: translateY(64px); }
    /* Relax */
    80% { height: 128px; transform: translateY(32px); }
  }

  /* Wide: Surprised eyes - pure 8-bit */
  @keyframes wide {
    0%, 100% { height: 192px; transform: translateY(0); }
    /* Eyes open wide */
    25% { height: 224px; transform: translateY(-16px); }
    /* Hold surprised */
    50%, 75% { height: 216px; transform: translateY(-8px); }
  }

  /* Shimmer: Simple highlight blink - pure 8-bit */
  @keyframes shimmer {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  /* State animations - TRUE 8-BIT pixel art style */
  
  /* Thinking: Pondering look - 6 discrete frames, pixel-snapped */
  @keyframes thinking {
    /* Frame 1: Normal */
    0%, 100% { 
      transform: translateY(0) translateX(0); 
      height: 192px;
    }
    /* Frame 2: Look up */
    16.66% { 
      transform: translateY(-16px) translateX(0); 
      height: 176px;
    }
    /* Frame 3: Think hard - squint + drift right */
    33.33% { 
      transform: translateY(-24px) translateX(8px); 
      height: 160px;
    }
    /* Frame 4: Hold thought */
    50% { 
      transform: translateY(-24px) translateX(8px); 
      height: 160px;
    }
    /* Frame 5: Drift left considering */
    66.66% { 
      transform: translateY(-16px) translateX(-8px); 
      height: 168px;
    }
    /* Frame 6: Settle back */
    83.33% { 
      transform: translateY(-8px) translateX(0); 
      height: 184px;
    }
  }

  /* Working: Focused look - 8 discrete frames, pixel-snapped */
  @keyframes working {
    /* Frame 1-2: Focused narrow gaze */
    0%, 12.5% { 
      height: 160px;
      transform: translateY(16px);
    }
    /* Frame 3-4: Deep focus */
    25%, 37.5% { 
      height: 152px;
      transform: translateY(24px);
    }
    /* Frame 5: Quick blink */
    50% { 
      height: 16px;
      transform: translateY(88px);
    }
    /* Frame 6: Eyes back open */
    62.5% { 
      height: 152px;
      transform: translateY(24px);
    }
    /* Frame 7-8: Continue focused */
    75%, 87.5% { 
      height: 160px;
      transform: translateY(16px);
    }
  }

  /* Happy: Joyful squinting eyes - pure 8-bit */
  @keyframes happy {
    0%, 100% { 
      height: 192px; 
      transform: translateY(0);
    }
    /* Squint happily */
    25%, 75% { 
      height: 96px; 
      transform: translateY(48px);
    }
    /* Hold happy squint */
    50% { 
      height: 80px; 
      transform: translateY(56px);
    }
  }

  /* Error: Simple 8-bit shake - just 3 discrete positions */
  @keyframes error {
    /* Normal */
    0%, 100% { transform: translateX(0); }
    /* Snap left */
    33% { transform: translateX(-16px); }
    /* Snap right */
    66% { transform: translateX(16px); }
  }

  /* Sleeping: Simple breathing - wider eyes (80px √ó 16px) */
  @keyframes sleeping {
    0%, 100% { 
      transform: translateY(0); 
    }
    /* Inhale - slight rise */
    50% { 
      transform: translateY(-8px); 
    }
  }

  /* ========== Settings Button & Modal ========== */
  
  .settings-btn {
    position: fixed;
    top: 24px;
    right: 24px;
    width: 48px;
    height: 48px;
    
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.1s steps(2);
    image-rendering: pixelated;
    z-index: 100;
  }

  .settings-btn:hover {
    transform: scale(1.1);
  }

  .settings-btn:active {
    transform: scale(0.95);
  }

  .settings-icon {
    width: 32px;
    height: 32px;
    color: #fff;
    image-rendering: pixelated;
  }

  /* Settings Modal */
  .settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    image-rendering: pixelated;
  }

  .settings-modal.open {
    display: flex;
    animation: fadeIn 0.2s steps(4);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .settings-panel {
    background: #2a2a3a;
    border: 8px solid #000;
    box-shadow: 
      8px 8px 0 #000,
      inset 4px 4px 0 rgba(255, 255, 255, 0.1);
    width: 90%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .settings-header {
    background: #1a1a2a;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 4px solid #000;
  }

  .settings-header h2 {
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    color: #fff;
    margin: 0;
    letter-spacing: 2px;
  }

  .close-btn {
    background: #c44;
    border: 4px solid #000;
    color: #fff;
    width: 32px;
    height: 32px;
    font-size: 16px;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    line-height: 1;
  }

  .close-btn:hover {
    background: #f55;
  }

  .settings-content {
    padding: 24px;
  }

  .setting-group {
    margin-bottom: 24px;
  }

  .setting-group label {
    display: block;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: #aaa;
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  .setting-group input {
    width: 100%;
    padding: 12px 16px;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    background: #1a1a2a;
    border: 4px solid #444;
    color: #fff;
    box-sizing: border-box;
  }

  .setting-group input:focus {
    outline: none;
    border-color: #D77757;
    box-shadow: 0 0 0 4px rgba(215, 119, 87, 0.3);
  }

  .setting-group input::placeholder {
    color: #555;
  }

  .setting-hint {
    display: block;
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    color: #666;
    margin-top: 6px;
    line-height: 1.5;
  }

  .settings-status {
    padding: 12px 16px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    margin-bottom: 16px;
    display: none;
    border: 4px solid;
  }

  .settings-status.success {
    display: block;
    background: #1a3a1a;
    border-color: #2a5a2a;
    color: #4f4;
  }

  .settings-status.error {
    display: block;
    background: #3a1a1a;
    border-color: #5a2a2a;
    color: #f44;
  }

  .settings-status.loading {
    display: block;
    background: #1a2a3a;
    border-color: #2a4a5a;
    color: #4af;
  }

  .settings-actions {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }

  .btn-primary, .btn-secondary {
    flex: 1;
    padding: 14px 20px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    border: 4px solid #000;
    cursor: pointer;
    transition: all 0.1s steps(2);
  }

  .btn-primary {
    background: #D77757;
    color: #fff;
  }

  .btn-primary:hover {
    background: #e88868;
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: #444;
    color: #fff;
  }

  .btn-secondary:hover {
    background: #555;
    transform: translateY(-2px);
  }

  .btn-primary:active, .btn-secondary:active {
    transform: translateY(2px);
  }

  .settings-info {
    background: #1a1a2a;
    border: 4px solid #333;
    padding: 16px;
  }

  .settings-info p {
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: #888;
    margin: 0 0 12px 0;
  }

  .settings-info code {
    display: block;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    color: #4f4;
    background: #0a0a1a;
    padding: 12px;
    line-height: 2;
    word-break: break-all;
  }

  /* ========== Session Settings Additional Styles ========== */

  .connection-status {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #1a1a2a;
    border: 4px solid #333;
    margin-bottom: 20px;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 0;
    background: #888;
  }

  .status-dot.connected {
    background: #4f4;
    box-shadow: 0 0 8px #4f4;
  }

  .status-dot.disconnected {
    background: #f44;
  }

  .status-text {
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: #aaa;
  }

  .token-display {
    display: flex;
    gap: 8px;
    align-items: stretch;
  }

  .token-display code {
    flex: 1;
    padding: 12px 16px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    background: #1a1a2a;
    border: 4px solid #444;
    color: #D77757;
    word-break: break-all;
    line-height: 1.5;
  }

  .btn-icon {
    padding: 12px 16px;
    background: #444;
    border: 4px solid #000;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.1s steps(2);
  }

  .btn-icon:hover {
    background: #555;
  }

  .btn-large {
    width: 100%;
    padding: 18px 24px;
    font-size: 12px;
  }

  .btn-danger {
    flex: 1;
    padding: 14px 20px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    border: 4px solid #000;
    cursor: pointer;
    transition: all 0.1s steps(2);
    background: #833;
    color: #fff;
  }

  .btn-danger:hover {
    background: #a44;
    transform: translateY(-2px);
  }

  .setup-instructions {
    background: #1a1a2a;
    border: 4px solid #333;
    padding: 16px;
    margin-top: 20px;
  }

  .setup-instructions h3 {
    font-family: 'Press Start 2P', monospace;
    font-size: 11px;
    color: #aaa;
    margin: 0 0 12px 0;
  }

  .setup-instructions ol {
    margin: 0;
    padding-left: 20px;
  }

  .setup-instructions li {
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    color: #888;
    margin-bottom: 8px;
    line-height: 1.8;
  }

  .setup-instructions code {
    background: #0a0a1a;
    padding: 2px 6px;
    color: #4f4;
  }

  .advanced-settings {
    margin-top: 20px;
    background: #1a1a2a;
    border: 4px solid #333;
  }

  .advanced-settings summary {
    padding: 14px 16px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    color: #888;
    cursor: pointer;
    list-style: none;
  }

  .advanced-settings summary::-webkit-details-marker {
    display: none;
  }

  .advanced-settings summary:hover {
    background: #2a2a3a;
    color: #aaa;
  }

  .advanced-settings[open] summary {
    border-bottom: 4px solid #333;
  }

  .advanced-settings .setting-group {
    padding: 16px;
    margin-bottom: 0;
  }

  .advanced-settings .settings-actions {
    padding: 16px;
    margin-bottom: 0;
  }
</style>

<script>
  let currentState = 'idle';
  let idleAnimationPaused = false;
  let inactivityTimer = null;
  let workingStateTimer = null;
  let claudeCodeSessionActive = false;
  let mascotSubscription = null;
  
  // Session and settings
  let session = {
    token: null,
    name: null
  };
  
  let settings = {
    workingTimeout: 5000,
    inactivityTimeout: 120000
  };

  const animations = [
    { name: 'blink', duration: 150, weight: 8, sync: true },
    { name: 'double-blink', duration: 400, weight: 3, sync: true },
    { name: 'sleepy', duration: 1200, weight: 0.2, sync: true },
    { name: 'look-left', duration: 600, weight: 0.8, sync: true },
    { name: 'look-right', duration: 600, weight: 0.8, sync: true },
    { name: 'look-up', duration: 500, weight: 0.4, sync: true },
    { name: 'squint', duration: 600, weight: 0.4, sync: true },
    { name: 'wide', duration: 400, weight: 0.4, sync: true },
    { name: 'shimmer', duration: 300, weight: 0.6, sync: false },
  ];

  // ========== Session Management ==========
  
  async function loadOrCreateSession() {
    // Try to load from localStorage
    const saved = localStorage.getItem('mascotSession');
    if (saved) {
      try {
        session = JSON.parse(saved);
        console.log('Loaded session from localStorage:', session.token?.substring(0, 8) + '...');
        
        // Verify session still exists on server
        const response = await fetch(`/api/sessions/${session.token}`);
        if (response.ok) {
          const data = await response.json();
          session.name = data.name;
          return true;
        } else {
          console.log('Session not found on server, creating new one');
        }
      } catch (e) {
        console.error('Failed to parse saved session:', e);
      }
    }
    
    // Create new session
    return await createNewSession();
  }

  async function createNewSession() {
    try {
      const response = await fetch('/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: 'My Computer' })
      });
      
      if (response.ok) {
        const data = await response.json();
        session.token = data.token;
        session.name = data.name;
        localStorage.setItem('mascotSession', JSON.stringify(session));
        console.log('Created new session:', session.token?.substring(0, 8) + '...');
        return true;
      }
    } catch (e) {
      console.error('Failed to create session:', e);
    }
    return false;
  }

  function loadSettings() {
    const saved = localStorage.getItem('mascotSettings');
    if (saved) {
      try {
        settings = { ...settings, ...JSON.parse(saved) };
      } catch (e) {
        console.error('Failed to parse saved settings:', e);
      }
    }
  }

  // ========== Animation Functions ==========

  function pickAnimation() {
    const totalWeight = animations.reduce((sum, a) => sum + a.weight, 0);
    let random = Math.random() * totalWeight;
    for (const anim of animations) {
      random -= anim.weight;
      if (random <= 0) return anim;
    }
    return animations[0];
  }

  function playRandomAnimation() {
    if (idleAnimationPaused) return;
    const leftEye = document.getElementById('left-eye');
    const rightEye = document.getElementById('right-eye');
    const anim = pickAnimation();

    animations.forEach(a => {
      leftEye.classList.remove(a.name);
      rightEye.classList.remove(a.name);
    });

    void leftEye.offsetWidth;
    leftEye.classList.add(anim.name);
    const rightDelay = anim.sync ? 0 : 80;
    setTimeout(() => rightEye.classList.add(anim.name), rightDelay);

    setTimeout(() => {
      leftEye.classList.remove(anim.name);
      rightEye.classList.remove(anim.name);
    }, anim.duration + 100);
  }

  function scheduleNext() {
    const delay = 3000 + Math.random() * 5000;
    setTimeout(() => {
      playRandomAnimation();
      scheduleNext();
    }, delay);
  }

  // ========== Timer Functions ==========

  function resetInactivityTimer() {
    if (inactivityTimer) clearTimeout(inactivityTimer);
    if (!claudeCodeSessionActive) {
      inactivityTimer = setTimeout(() => {
        console.log('Inactivity detected - going to sleep');
        window.updateMascotState('sleeping');
      }, settings.inactivityTimeout);
    }
  }

  function resetWorkingStateTimer(state) {
    if (workingStateTimer) {
      clearTimeout(workingStateTimer);
      workingStateTimer = null;
    }
    if (state === 'thinking' || state === 'working') {
      workingStateTimer = setTimeout(() => {
        console.log(`Working state timeout - returning to idle`);
        window.updateMascotState('idle', 'WorkingTimeout');
      }, settings.workingTimeout);
    }
  }

  // ========== State Update ==========

  window.updateMascotState = function(state, event) {
    const leftEye = document.getElementById('left-eye');
    const rightEye = document.getElementById('right-eye');

    if (event === 'SessionStart') {
      claudeCodeSessionActive = true;
    } else if (event === 'Stop' || event === 'SessionEnd') {
      claudeCodeSessionActive = false;
    }

    ['state-thinking', 'state-working', 'state-sleeping', 'state-happy', 'state-error'].forEach(cls => {
      leftEye.classList.remove(cls);
      rightEye.classList.remove(cls);
    });

    animations.forEach(a => {
      leftEye.classList.remove(a.name);
      rightEye.classList.remove(a.name);
    });

    currentState = state;
    resetWorkingStateTimer(state);

    if (state === 'idle') {
      idleAnimationPaused = false;
      resetInactivityTimer();
    } else if (state === 'sleeping') {
      idleAnimationPaused = true;
      if (inactivityTimer) clearTimeout(inactivityTimer);
      leftEye.classList.add('state-sleeping');
      rightEye.classList.add('state-sleeping');
    } else {
      idleAnimationPaused = true;
      resetInactivityTimer();
      leftEye.classList.add(`state-${state}`);
      rightEye.classList.add(`state-${state}`);
    }

    console.log(`Mascot state changed to: ${state}`);
  };

  // ========== WebSocket Connection Callbacks ==========

  window.onMascotConnected = function() {
    updateConnectionStatus(true);
  };

  window.onMascotDisconnected = function() {
    updateConnectionStatus(false);
  };

  function updateConnectionStatus(connected) {
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    if (statusDot && statusText) {
      statusDot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
      statusText.textContent = connected ? 'Connected' : 'Disconnected';
    }
  }

  // ========== Initialization ==========

  document.addEventListener('DOMContentLoaded', async () => {
    const leftEye = document.getElementById('left-eye');
    const rightEye = document.getElementById('right-eye');
    leftEye.classList.add('state-sleeping');
    rightEye.classList.add('state-sleeping');
    currentState = 'sleeping';
    idleAnimationPaused = true;

    scheduleNext();
    loadSettings();
    
    // Load or create session
    const sessionOk = await loadOrCreateSession();
    
    if (sessionOk && session.token) {
      // Create WebSocket subscription with token
      if (window.createMascotSubscription) {
        mascotSubscription = window.createMascotSubscription(session.token);
      }
      
      // Check current session status
      try {
        const response = await fetch(`/api/hooks/status`, {
          headers: { 'Authorization': `Bearer ${session.token}` }
        });
        if (response.ok) {
          const data = await response.json();
          claudeCodeSessionActive = data.session_active;
          if (data.session_active && data.state && data.state !== 'sleeping') {
            window.updateMascotState(data.state);
          }
        }
      } catch (e) {
        console.error('Failed to fetch session status:', e);
      }
    }
    
    initSettingsPanel();
  });

  // ========== Settings Panel ==========

  function initSettingsPanel() {
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeBtn = document.getElementById('close-settings');
    const saveBtn = document.getElementById('save-settings');
    const downloadBtn = document.getElementById('download-hooks');
    const copyTokenBtn = document.getElementById('copy-token');
    const regenerateBtn = document.getElementById('regenerate-token');
    const sessionNameInput = document.getElementById('session-name');
    const sessionTokenEl = document.getElementById('session-token');
    const workingTimeoutInput = document.getElementById('working-timeout');
    const inactivityTimeoutInput = document.getElementById('inactivity-timeout');
    const statusEl = document.getElementById('settings-status');

    function populateForm() {
      sessionNameInput.value = session.name || '';
      sessionTokenEl.textContent = session.token || 'No session';
      workingTimeoutInput.value = settings.workingTimeout / 1000;
      inactivityTimeoutInput.value = settings.inactivityTimeout / 60000;
      updateConnectionStatus(mascotSubscription !== null);
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = 'settings-status ' + type;
      if (type !== 'loading') {
        setTimeout(() => { statusEl.className = 'settings-status'; }, 5000);
      }
    }

    // Open modal
    settingsBtn.addEventListener('click', () => {
      populateForm();
      settingsModal.classList.add('open');
    });

    // Close modal
    closeBtn.addEventListener('click', () => settingsModal.classList.remove('open'));
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) settingsModal.classList.remove('open');
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && settingsModal.classList.contains('open')) {
        settingsModal.classList.remove('open');
      }
    });

    // Copy token
    copyTokenBtn.addEventListener('click', async () => {
      if (session.token) {
        await navigator.clipboard.writeText(session.token);
        showStatus('‚úì TOKEN COPIED!', 'success');
      }
    });

    // Download hooks
    downloadBtn.addEventListener('click', () => {
      if (session.token) {
        window.location.href = `/api/sessions/${session.token}/hooks`;
      } else {
        showStatus('‚úó NO SESSION TOKEN', 'error');
      }
    });

    // Save settings
    saveBtn.addEventListener('click', async () => {
      const workingSec = parseInt(workingTimeoutInput.value) || 5;
      const inactivityMin = parseInt(inactivityTimeoutInput.value) || 2;

      if (workingSec < 1 || workingSec > 60) {
        showStatus('Working timeout: 1-60 seconds', 'error');
        return;
      }
      if (inactivityMin < 1 || inactivityMin > 30) {
        showStatus('Sleep timeout: 1-30 minutes', 'error');
        return;
      }

      // Update session name on server
      if (sessionNameInput.value !== session.name) {
        try {
          await fetch(`/api/sessions/${session.token}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: sessionNameInput.value })
          });
          session.name = sessionNameInput.value;
          localStorage.setItem('mascotSession', JSON.stringify(session));
        } catch (e) {
          console.error('Failed to update session name:', e);
        }
      }

      settings.workingTimeout = workingSec * 1000;
      settings.inactivityTimeout = inactivityMin * 60000;
      localStorage.setItem('mascotSettings', JSON.stringify(settings));

      showStatus('‚úì SAVED!', 'success');
    });

    // Regenerate token
    regenerateBtn.addEventListener('click', async () => {
      if (!confirm('This will invalidate your current hooks. You will need to download and reinstall them. Continue?')) {
        return;
      }

      showStatus('REGENERATING...', 'loading');

      try {
        const response = await fetch(`/api/sessions/${session.token}/regenerate`, {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          session.token = data.token;
          localStorage.setItem('mascotSession', JSON.stringify(session));
          sessionTokenEl.textContent = session.token;

          // Recreate subscription with new token
          if (mascotSubscription) {
            mascotSubscription.unsubscribe();
          }
          if (window.createMascotSubscription) {
            mascotSubscription = window.createMascotSubscription(session.token);
          }

          showStatus('‚úì NEW TOKEN GENERATED!', 'success');
        } else {
          showStatus('‚úó FAILED TO REGENERATE', 'error');
        }
      } catch (e) {
        showStatus('‚úó ERROR: ' + e.message, 'error');
      }
    });
  }
</script>

